<!DOCTYPE html>
<html>
  <%- include('./partials/head.ejs') %>
  <body class="bg-gray-900 text-gray-100">
    <!-- Main container for the control panel -->
    <div class="container">
      <h1 class="text-4xl font-bold mb-8 text-blue-400">
        Speed: <strong id="speedText"></strong> km/h
      </h1>
      <div class="tcenter">
        <canvas id="canvas">
          Lo sentimos, su navegador no es compatible &lt;canvas&gt;.
        </canvas>
      </div>
      <select class="form-select" style="margin: 15px 0px;" id="resolutionSelect">
        <option value="FRAMESIZE_96X96">96X96</option>
        <option value="FRAMESIZE_QQVGA">QQVGA</option>
        <option value="FRAMESIZE_240X240">240X240</option>
        <option value="FRAMESIZE_UXGA">UXGA</option>
      </select>
      <!-- Container for the directional control buttons -->
      <div class="control-grid">
        <!-- Forward button -->
        <button
          id="forwardBtn"
          class="up-button w-16 h-16 bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-4 focus:ring-green-400"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8 mx-auto"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 10l7-7m0 0l7 7m-7-7v18"
            />
          </svg>
        </button>

        <!-- Stop button -->
        <button
          id="rightBtn"
          class="right-button w-16 h-16 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-4 focus:ring-red-400"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8 mx-auto"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            />
          </svg>
        </button>

        <!-- Backward button -->
        <button
          id="backwardBtn"
          class="down-button w-16 h-16 bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-4 focus:ring-blue-400"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8 mx-auto"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 14l-7 7m0 0l-7-7m7 7V3"
            />
          </svg>
        </button>
        <button
          id="leftBtn"
          class="left-button w-16 h-16 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-4 focus:ring-blue-400"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8 mx-auto"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            />
          </svg>
        </button>
      </div>

      <!-- Status message display -->
      <p id="status" class="mt-8 text-xl text-gray-300">Awaiting command...</p>
    </div>

    <script>
      const statusElement = document.getElementById("status");

      /**
       * @brief Sends a PUT request to the specified endpoint.
       * @param endpoint The URL path to send the request to (e.g., '/forward').
       */
      async function sendGetRequest(endpoint) {
        // Replace with your ESP32's actual IP address
        const esp32IP = "192.168.4.1"; // Default IP when using softAP
        const url = `http://${esp32IP}${endpoint}`;

        try {
          statusElement.textContent = `Sending request to: ${endpoint}...`;
          const response = await fetch(url, {
            method: "GET",
            // The ESP32 server doesn't require a body, but we'll include it for clarity
            headers: { "Content-Type": "text/plain" },
          });

          if (response.ok) {
            const message = await response.text();
            statusElement.textContent = `Success: ${message}`;
          } else {
            statusElement.textContent = `Error: HTTP status ${response.status}`;
            console.error(`Error: HTTP status ${response.status}`);
          }
        } catch (error) {
          statusElement.textContent = "Error: Could not connect to ESP32.";
          console.error("Error:", error);
        }
      }

      const speedText = document.getElementById("speedText");

      // Add event listeners to each button
      document
        .getElementById("forwardBtn")
        .addEventListener("mousedown", () => {
          sendGetRequest("/forward");
        });

      document
        .getElementById("backwardBtn")
        .addEventListener("mousedown", () => {
          sendGetRequest("/backward");
        });

      document.getElementById("rightBtn").addEventListener("mousedown", () => {
        sendGetRequest("/right");
      });

      document.getElementById("leftBtn").addEventListener("mousedown", () => {
        sendGetRequest("/left");
      });

      document.getElementById("forwardBtn").addEventListener("mouseup", () => {
        sendGetRequest("/stop");
      });

      document.getElementById("backwardBtn").addEventListener("mouseup", () => {
        sendGetRequest("/stop");
      });

      document.getElementById("rightBtn").addEventListener("mouseup", () => {
        sendGetRequest("/stop");
      });

      document.getElementById("leftBtn").addEventListener("mouseup", () => {
        sendGetRequest("/stop");
      });

      function pollingSpeed() {
        const esp32IP = "192.168.4.1"; // Default IP when using softAP
        const url = `http://${esp32IP}/speed`;
        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            speedText.innerText = data;
          })
          .catch((error) => console.error("Error fetching data:", error));
      }

      // Poll every 5 seconds
      setInterval(pollingSpeed, 1000);

      document.addEventListener("keydown", (event) => {
        if (event.repeat) {
          return;
        }
        // Log the key that was pressed

        // Perform actions based on specific keys
        if (event.key === "w") {
          sendGetRequest("/forward");
        } else if (event.key === "a") {
          sendGetRequest("/left");
        } else if (event.key === "s") {
          sendGetRequest("/backward");
        } else if (event.key === "d") {
          sendGetRequest("/right");
        }
      });

      document.addEventListener("keyup", (event) => {
        if (event.repeat) {
          return;
        }
        // Log the key that was pressed
        console.log("Key pressed:", event.key);

        // Perform actions based on specific keys
        if (event.key === "w") {
          sendGetRequest("/stop");
        } else if (event.key === "a") {
          sendGetRequest("/stop");
        } else if (event.key === "s") {
          sendGetRequest("/stop");
        } else if (event.key === "d") {
          sendGetRequest("/stop");
        }
      });

      var last_time = new Date();
      var portStr = "";
      if (location.port != "") {
        portStr = ":" + location.port;
      }
      var protocolStr = "ws";
      if (location.protocol === "https:") {
        protocolStr = "wss";
      }
      console.log(
        protocolStr + "://" + location.hostname + portStr + "/jpgstream_client"
      );
      var ws = new WebSocket(
        protocolStr + "://" + location.hostname + portStr + "/jpgstream_client"
      );
      var canvas = document.getElementById("canvas");
      var ctx = canvas.getContext("2d");

      var img = new Image();
      img.onload = function () {
        canvas.style.width = this.width + "px";
        canvas.style.height = this.height + "px";
        ctx.drawImage(
          this,
          0,
          0,
          this.width,
          this.height, // source rectangle
          0,
          0,
          canvas.width,
          canvas.height
        ); // destination rectangle
      };
      let fps = [];
      img.src =
        "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAA1BMVEUAAACnej3aAAAASElEQVR4nO3BgQAAAADDoPlTX+AIVQEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwDcaiAAFXD1ujAAAAAElFTkSuQmCC";
      ws.onmessage = function (message) {
        if (typeof message.data === "string") {
          let width = 100 - message.data / 5;
          document.getElementById("sensor").style.width = width + "%";
          if (width < 40) {
            document.getElementById("sensor").className = "bg-success";
          } else if (width < 70) {
            document.getElementById("sensor").className = "bg-warning";
          } else {
            document.getElementById("sensor").className = "bg-danger";
          }
        } else {
          var url = URL.createObjectURL(message.data);
          img.src = url;
        }
      };

      document.getElementById("resolutionSelect").onchange = (e) => {
        ws.send(
          JSON.stringify({ action: "resolution", value: e.target.value })
        );
        fps = [];
      };
    </script>
  </body>
</html>
<html></html>
